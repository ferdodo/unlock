use wasm_bindgen::prelude::*;
use image::codecs::gif;
use crate::gif::{GifEncoder, Repeat};
use image::{Frame, Rgba, Delay};
use image::ImageBuffer;
use std::io::{Cursor};

#[wasm_bindgen]
pub fn convert_hexstrings_to_animated_gif(hex_strings: Vec<String>) -> String {
    let mut frames: Vec<Frame> = Vec::new();

    for hex_string in hex_strings {
		let image_data = match hex::decode(&hex_string) {
			Ok(b) => b,
			Err(err) => panic!("Failed to decode png hexstring ! \n {:?}", err)
		};

        let image = match image::load_from_memory(&image_data) {
       		Ok(b) => b,
			Err(err) => panic!("Failed to load image from buffer ! \n {:?}", err)
        };

        let rgba_image = image.to_rgba8();
        let delay = Delay::from_numer_denom_ms(100, 1);
        let raw_rgba_image: ImageBuffer<Rgba<u8>, Vec<u8>> = rgba_image;
        frames.push(Frame::from_parts(raw_rgba_image, image.width(), image.height(), delay));
    }

    let mut gif_data = Vec::new();
    let mut writer = Cursor::new(&mut gif_data);

    {
    	let mut encoder = GifEncoder::new(&mut writer);

    	match encoder.set_repeat(Repeat::Infinite) {
			Ok(b) => b,
			Err(err) => panic!("Failed to set gif repeat ! \n {:?}", err)
    	}

    	match encoder.encode_frames(frames) {
    		Ok(b) => b,
			Err(err) => panic!("Failed to encode frames to animated gif ! \n {:?}", err)
    	}
    }
    
    let gif_data_2 = writer.into_inner();

    let hex_gif_data: String = gif_data_2.iter().map(|b| format!("{:02X}", b)).collect();

    hex_gif_data
}


#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_convert_hexstrings_to_animated_gif() {
        let hex_strings = vec![
            "89504E470D0A1A0A0000000D4948445200000064000000640802000000FF80020300000183694343504943432070726F66696C65000028917D913D48C3401CC55F5345918A8345441D32D44E1644451CB50A45A8106A85561D4C2EFD82260D498A8BA3E05A70F063B1EAE0E2ACAB83AB20087E80383B3829BA4889FF4B0A2D623C38EEC7BB7B8FBB7780502F33CDEA180734DD365389B898C9AE8A5DAF10308C0144019959C69C2425E13BBEEE11E0EB5D8C67F99FFB73F4AA398B010191789619A64DBC413CBD691B9CF789C3AC28ABC4E7C463265D90F891EB8AC76F9C0B2E0B3C336CA653F3C46162B1D0C64A1BB3A2A9114F1147544DA77C21E3B1CA798BB356AEB2E63DF90B43397D6599EB344790C02296204184822A4A28C3468C569D140B29DA8FFBF8875CBF442E855C2530722CA0020DB2EB07FF83DFDD5AF9C9092F2914073A5F1CE76314E8DA051A35C7F93E769CC609107C06AEF496BF5207663E49AFB5B4C811D0B70D5C5CB734650FB8DC01069F0CD9945D294853C8E781F733FAA62CD07F0BF4AC79BD35F771FA00A4A9ABE40D707008440B94BDEEF3EEEEF6DEFE3DD3ECEF075306729ACA671692000000097048597300002E2300002E230178A53F760000000774494D4507E8021B16261EEA61D1340000001974455874436F6D6D656E74004372656174656420776974682047494D5057810E170000009E4944415478DAEDD031010000080320B57FE759C1CF0722D029AE46812C59B264C992A540962C59B264C952204B962C59B2642990254B962C59B214C892254B962C590A64C992254B962C05B264C992254B960259B264C992254B812C59B264C992A540962C59B264C952204B962C59B2642990254B962C59B214C892254B962C590A64C992254B962C05B264C992254B960259B264C992254B812C59DF168A5E01C76AFAB7B70000000049454E44AE426082".to_string(),
            "89504E470D0A1A0A0000000D4948445200000064000000640802000000FF80020300000183694343504943432070726F66696C65000028917D913D48C3401CC55F5345918A8345441D32D44E1644451CB50A45A8106A85561D4C2EFD82260D498A8BA3E05A70F063B1EAE0E2ACAB83AB20087E80383B3829BA4889FF4B0A2D623C38EEC7BB7B8FBB7780502F33CDEA180734DD365389B898C9AE8A5DAF10308C0144019959C69C2425E13BBEEE11E0EB5D8C67F99FFB73F4AA398B010191789619A64DBC413CBD691B9CF789C3AC28ABC4E7C463265D90F891EB8AC76F9C0B2E0B3C336CA653F3C46162B1D0C64A1BB3A2A9114F1147544DA77C21E3B1CA798BB356AEB2E63DF90B43397D6599EB344790C02296204184822A4A28C3468C569D140B29DA8FFBF8875CBF442E855C2530722CA0020DB2EB07FF83DFDD5AF9C9092F2914073A5F1CE76314E8DA051A35C7F93E769CC609107C06AEF496BF5207663E49AFB5B4C811D0B70D5C5CB734650FB8DC01069F0CD9945D294853C8E781F733FAA62CD07F0BF4AC79BD35F771FA00A4A9ABE40D707008440B94BDEEF3EEEEF6DEFE3DD3ECEF075306729ACA671692000000097048597300002E2300002E230178A53F760000000774494D4507E8021B16261EEA61D1340000001974455874436F6D6D656E74004372656174656420776974682047494D5057810E170000009E4944415478DAEDD031010000080320B57FE759C1CF0722D029AE46812C59B264C992A540962C59B264C952204B962C59B2642990254B962C59B214C892254B962C590A64C992254B962C05B264C992254B960259B264C992254B812C59B264C992A540962C59B264C952204B962C59B2642990254B962C59B214C892254B962C590A64C992254B962C05B264C992254B960259B264C992254B812C59DF168A5E01C76AFAB7B70000000049454E44AE426082".to_string(),
        ];

        let result = convert_hexstrings_to_animated_gif(hex_strings);
        assert_eq!(result.len(), 646);
    }
}
